<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Disaster Response Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 90vh; width: 100%; }
        .info-box { background: white; padding: 10px; }
        #controls { text-align: center; margin-bottom: 10px; }
        input, select, button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Smart Disaster Response Map for Earthquake Monitoring</h1>
    <div id="controls">
        <input type="text" id="locationFilter" placeholder="Enter location keyword">
        <select id="magnitudeFilter">
            <option value="0">All Magnitudes</option>
            <option value="2">2+</option>
            <option value="4">4+</option>
            <option value="6">6+</option>
        </select>
        <label>Start Date: <input type="date" id="startDate"></label>
        <label>End Date: <input type="date" id="endDate"></label>
        <select id="dataType" onchange="loadEarthquakeData()">
            <option value="realtime">Real-Time Data</option>
            <option value="historical">Historical Data (1970-2014)</option>
        </select>
        <button onclick="applyFilterAndReload()">Apply Filter</button>
        <label>Zoom to level: <input type="number" id="zoomLevel" min="2" max="12" value="2" onchange="adjustZoom()"></label>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let earthquakeLayer;

        const map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        function getColor(mag) {
            return mag > 5 ? '#FF0000' :
                   mag > 4 ? '#FF7F00' :
                   mag > 3 ? '#FFFF00' :
                   mag > 2 ? '#7FFF00' :
                              '#00FF00';
        }

        function adjustZoom() {
            const zoom = parseInt(document.getElementById('zoomLevel').value);
            map.setZoom(zoom);
        }

        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += '<h4>Magnitude</h4>';
            div.innerHTML += '<i style="background:#00FF00"></i><span>0-2</span><br>';
            div.innerHTML += '<i style="background:#7FFF00"></i><span>2-3</span><br>';
            div.innerHTML += '<i style="background:#FFFF00"></i><span>3-4</span><br>';
            div.innerHTML += '<i style="background:#FF7F00"></i><span>4-5</span><br>';
            div.innerHTML += '<i style="background:#FF0000"></i><span>5+</span><br>';
            return div;
        };

        legend.addTo(map);

        let allEarthquakes = [];

        function loadEarthquakeData() {
            const dataType = document.getElementById('dataType').value;
            let dataUrl;

            if (dataType === 'historical') {
                dataUrl = 'https://data.humdata.org/dataset/8c15f5fd-f7d3-4c80-8a71-7b385f4c0034/resource/22b12df7-9d88-4c45-b0e5-d4b555eae6a5/download/catalog-of-earthquakes1970-2014.geojson';
            } else {
                dataUrl = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson';
            }

            fetch(dataUrl)
                .then(response => response.json())
                .then(data => {
                    allEarthquakes = data.features;
                    applyFilterAndReload();
                })
                .catch(err => console.error('Error fetching earthquake data:', err));
        }

        function displayEarthquakes(earthquakes) {
            if (earthquakeLayer) {
                earthquakeLayer.clearLayers();
            }

            earthquakeLayer = L.layerGroup();

            earthquakes.forEach(eq => {
                const coords = eq.geometry.coordinates;
                const mag = eq.properties.mag;
                const place = eq.properties.place || eq.properties.location;
                const timeVal = eq.properties.time || eq.properties.date;
                const dateObj = new Date(timeVal);
                const time = dateObj.toLocaleString();

                const marker = L.circleMarker([coords[1], coords[0]], {
                    radius: mag * 3,
                    color: getColor(mag),
                    fillOpacity: 0.7
                }).bindPopup(`<b>Location:</b> ${place}<br><b>Magnitude:</b> ${mag}<br><b>Time:</b> ${time}`);

                if (mag >= 6 && document.getElementById('dataType').value === 'realtime') {
                    alert(`Emergency Alert: Earthquake of magnitude ${mag} detected near ${place}`);
                }

                earthquakeLayer.addLayer(marker);
            });

            earthquakeLayer.addTo(map);
        }

        function applyFilterAndReload() {
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const magnitudeFilter = parseFloat(document.getElementById('magnitudeFilter').value);
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filtered = allEarthquakes.filter(eq => {
                const mag = eq.properties.mag;
                const place = (eq.properties.place || eq.properties.location).toLowerCase();
                const eqDate = new Date(eq.properties.time || eq.properties.date);

                const dateMatch = (!isNaN(startDate) ? eqDate >= startDate : true) && (!isNaN(endDate) ? eqDate <= endDate : true);

                return mag >= magnitudeFilter && place.includes(locationFilter) && dateMatch;
            });

            displayEarthquakes(filtered);
        }

        loadEarthquakeData();
    </script>
</body>
</html>
